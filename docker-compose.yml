services:
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    hostname: caddy
    restart: unless-stopped
    environment:
      BASIC_AUTH_USER: "${BASIC_AUTH_USER}"
      BASIC_AUTH_HASH: "${BASIC_AUTH_HASH}"
      CADDY_AUTH_ENABLED: "${CADDY_AUTH_ENABLED:-true}"
      JELLYFIN_AUTH_ENABLED: "${JELLYFIN_AUTH_ENABLED:-false}"
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/data:/data
      - ./caddy/config:/config
      - ./caddy/site:/srv:ro
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 1s
    depends_on:
      - jellyfin
      - jellyseerr
      - qbittorrent
      - prowlarr
      - radarr
      - sabnzbd

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    hostname: cloudflared
    restart: unless-stopped
    depends_on:
      - caddy
    command: tunnel --config /etc/cloudflared/config.yml --metrics 0.0.0.0:2000 run
    volumes:
      - ./cloudflared:/etc/cloudflared
    healthcheck:
      test: ["CMD", "cloudflared", "version"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 1s
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    hostname: jellyfin
    restart: unless-stopped
    environment:
      TZ: "${TZ:-Asia/Tashkent}"
      JELLYFIN_PublishedServerUrl: "${JELLYFIN_PUBLISHED_URL:-}"
    user: "${PUID:-1000}:${PGID:-1000}"
    ports:
      - "${JELLYFIN_HTTP_PORT:-3278}:8096"
      - "${JELLYFIN_HTTPS_PORT:-3279}:8920"
    volumes:
      - ./data/jellyfin/config:/config
      - ./data/jellyfin/cache:/cache
      - ./data/jellyfin/config/index.html:/jellyfin/jellyfin-web/index.html
      - "${JELLYFIN_MOVIES:-/Volumes/MEDIA1/Movies}:/Volumes/Movies"
      - "${JELLYFIN_SERIES:-/Volumes/MEDIA1/Series}:/Volumes/Series"

  jellyseerr:
    image: ghcr.io/fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    hostname: jellyseerr
    restart: unless-stopped
    environment:
      TZ: "${TZ:-Asia/Tashkent}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      PORT: "5055"
    user: "${PUID:-1000}:${PGID:-1000}"
    ports:
      - "${JELLYSEERR_PORT:-3277}:5055"
    volumes:
      - ./data/jellyseerr/config:/app/config
      - ./data/jellyseerr/cache:/app/.cache
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    hostname: qbittorrent
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Tashkent}"
      WEBUI_PORT: "8080"
      UMASK_SET: "${UMASK_SET:-002}"  # allow group write for shared media
    ports:
      - "127.0.0.1:${QBITTORRENT_WEB_PORT:-3275}:8080"
      - "${QBITTORRENT_PEER_PORT:-6881}:6881"
      - "${QBITTORRENT_PEER_PORT:-6881}:6881/udp"
    volumes:
      - ./data/qbittorrent/config:/config
      - "${DOWNLOADS_ROOT:-/Volumes/SCRAPFS/downloads}:/downloads"
      - "${QBITTORRENT_WATCH:-/data/qbittorrent/watch}:/watch"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    hostname: prowlarr
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Tashkent}"
    ports:
      - "${PROWLARR_PORT:-3276}:9696"
    volumes:
      - ./data/prowlarr/config:/config
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9696/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    hostname: radarr
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Tashkent}"
    ports:
      - "${RADARR_PORT:-3273}:7878"
    volumes:
      - ./data/radarr/config:/config
      - "${DOWNLOADS_ROOT:-/Volumes/SCRAPFS/downloads}:/downloads"
      - "${JELLYFIN_MOVIES:-/Volumes/MEDIA1/Movies}:/movies"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:7878/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    hostname: sabnzbd
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Tashkent}"
      UMASK_SET: "${UMASK_SET:-002}"
    ports:
      - "${SABNZBD_PORT:-3274}:8080"
    volumes:
      - ./data/sabnzbd/config:/config
      - "${DOWNLOADS_ROOT:-/Volumes/SCRAPFS/downloads}:/downloads"
      - "${INCOMPLETE_ROOT:-/Volumes/SCRAPFS/downloads/incomplete}:/incomplete"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    hostname: sonarr
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Tashkent}"
    ports:
      - "${SONARR_PORT:-3272}:8989"
    volumes:
      - ./data/sonarr/config:/config
      - "${DOWNLOADS_ROOT:-/Volumes/SCRAPFS/downloads}:/downloads"
      - "${JELLYFIN_SERIES:-/Volumes/MEDIA1/Series}:/series"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8989/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    hostname: recyclarr
    restart: unless-stopped
    user: "${PUID:-1000}:${PGID:-1000}"
    environment:
      TZ: "${TZ:-Asia/Tashkent}"
      CRON_SCHEDULE: "${RECYCLARR_CRON:-0 4 * * *}"
      LOG_LEVEL: "debug"
    volumes:
      - ./data/recyclarr/config:/config


networks:
  default:
    name: media_net

# DulceJelly Infrastructure

This directory contains all infrastructure setup and management tools for DulceJelly.

## Contents

- **`setup.ts`** - Interactive setup script that generates local configurations
- **`cloudflare/`** - Pulumi TypeScript project for provisioning Cloudflare resources

## Quick Start

### Step 1: Run Setup Script

Generate local configuration files:

```bash
cd infra
npm install
npm run setup
```

This will prompt you for:
- Domain name
- Cloudflare Tunnel ID
- Service hostnames
- Security preferences

And generate:
- `../media-server/cloudflared/config.yml` (tunnel ingress rules)
- `../media-server/caddy/Caddyfile.generated` (reverse proxy config)
- `../media-server/.env.additions` (environment variables)
- `cloudflare/Pulumi.config-snippet.yaml` (Pulumi configuration)

### Step 2: Deploy Cloudflare Resources

Provision DNS, WAF, and optional Access policies:

```bash
cd cloudflare
npm install
pulumi login
pulumi stack init prod

# Configure credentials
pulumi config set --secret cloudflare:apiToken YOUR_API_TOKEN
pulumi config set cloudflare:accountId YOUR_ACCOUNT_ID
pulumi config set zoneId YOUR_ZONE_ID

# Merge settings from Pulumi.config-snippet.yaml into Pulumi.prod.yaml

# Deploy
pulumi preview
pulumi up
```

## What's Provisioned

### Local Configuration (Generated by setup script)

- **Cloudflare Tunnel ingress rules** (local YAML)
- **Caddy reverse proxy routing** (vhost-based)
- **Environment variables** for services

### Cloud Resources (Managed by Pulumi)

- **DNS records** for all service subdomains
- **WAF rules** (bot blocking, exploit scanner blocking)
- **Rate limiting** (Jellyfin auth brute-force protection)
- **Optional: Cloudflare Access** applications and policies (admin services only)

## Design Philosophy

**Separation of Concerns:**

- **Local ingress configuration**: Managed locally in YAML (version controlled, no API calls)
- **Cloud resources**: Managed via Pulumi IaC (DNS, security rules, Access policies)

**Why This Split?**

- Cloudflare recommends local YAML for tunnel ingress (faster, no rate limits)
- DNS and security are cloud-native resources that benefit from IaC
- Clear separation between edge configuration and routing logic

## Further Reading

- **[Setup Script Details](#setup-script)** (below)
- **[Cloudflare Resources](cloudflare/README.md)** - Pulumi project documentation
- **[Architecture](../media-server/docs/Architecture.md)** - Overall system architecture

---

## Setup Script

The `setup.ts` script is an interactive wizard that:

1. **Collects configuration** via prompts
2. **Generates local files** (tunnel config, Caddy config, env vars)
3. **Creates Pulumi config snippet** ready to merge into your stack

### Usage

```bash
npm run setup
```

### What It Generates

| File | Purpose |
|------|---------|
| `../media-server/cloudflared/config.yml` | Tunnel ingress rules (hostname → service mapping) |
| `../media-server/caddy/Caddyfile.generated` | Reverse proxy vhost routing with auth |
| `../media-server/.env.additions` | Environment variables to merge into `.env` |
| `cloudflare/Pulumi.config-snippet.yaml` | Pulumi config to merge into stack config |

### Prompts

The script will ask for:

- **Domain name** (e.g., `mymedialibrary.example`)
- **Cloudflare Tunnel ID** (from tunnel creation)
- **Tunnel credentials filename** (JSON file)
- **Service hostnames** (subdomains for each service)
- **Caddy auth preferences** (enable/disable for admin services and Jellyfin)

### After Running

1. **Copy tunnel credentials**: `cp <tunnel-id>.json ../media-server/cloudflared/`
2. **Review generated files** before using them
3. **Merge configurations**:
   - Review `Caddyfile.generated` → replace `Caddyfile` if satisfied
   - Merge `.env.additions` into `.env`
   - Merge `Pulumi.config-snippet.yaml` into your stack config
4. **Deploy infrastructure**: Follow Step 2 above

---

## Directory Structure

```
infra/
├── package.json              # Setup script dependencies
├── setup.ts                  # Interactive configuration generator
├── README.md                 # This file
└── cloudflare/               # Pulumi project
    ├── package.json          # Pulumi dependencies
    ├── index.ts              # Infrastructure definitions
    ├── Pulumi.yaml           # Project config
    ├── Pulumi.dev.yaml       # Example stack config
    ├── tsconfig.json         # TypeScript config
    └── README.md             # Pulumi project docs
```

## Maintenance

### Changing Hostnames

1. Re-run `npm run setup` with new hostnames
2. Update `cloudflared/config.yml` with new ingress rules
3. Update Pulumi config and run `pulumi up` to update DNS records
4. Restart services: `cd ../media-server && docker compose restart`

### Rotating Tunnel Credentials

1. Create new tunnel in Cloudflare dashboard
2. Download new credentials JSON
3. Update `cloudflared/config.yml` with new tunnel ID
4. Copy new credentials file to `cloudflared/`
5. Update Pulumi config with new tunnel ID
6. Run `pulumi up` to update DNS CNAME targets
7. Restart cloudflared: `docker compose restart cloudflared`

### Adding New Services

1. Add service to `docker-compose.yml`
2. Re-run `npm run setup` (or manually edit configs)
3. Update Pulumi config with new hostname
4. Run `pulumi up` to create DNS record
5. Restart services

## Troubleshooting

**Setup script fails:**
- Ensure Node.js v18+ is installed
- Run `npm install` first
- Check write permissions on `media-server/` directories

**Pulumi fails:**
- Verify API token has correct permissions (Zone:DNS:Edit, Zone:Zone:Read)
- Check account ID and zone ID are correct
- Ensure you've run `pulumi login` and `pulumi stack init`

**DNS not resolving:**
- Check DNS records in Cloudflare dashboard (should be CNAME, proxied)
- Verify tunnel ID matches in both `config.yml` and Pulumi config
- Wait a few minutes for DNS propagation

---

For more help, see:
- [Main README](../README.md) - Full setup guide
- [Architecture docs](../media-server/docs/Architecture.md) - Technical details
- [Cloudflare Pulumi docs](cloudflare/README.md) - IaC specifics

# Save this to data/quality-broker/config/config.yaml
batchSize: 10
autoAssignProfile: AutoAssignQuality
# Optional: set to a profile name to re-evaluate all movies in that profile.
# Leave empty to only process AutoAssignQuality queue.
reviseQualityForProfile: ""
# Profiles in this list are never modified by quality-broker (no profile/tag updates).
# Default behavior protects DontUpgrade titles from accidental reassignment.
ignoredProfilesFromChanges:
  - DontUpgrade
decisionProfiles:
  - HD
  - Efficient-4K
  - HighQuality-4K

# Delay (ms) before each LLM request to avoid 429s on large queues.
# Set to 0 to disable.
llmRequestDelayMs: 1200

radarr:
  # URL auto-derives from LAN_HOSTNAME/RADARR_PORT (or radarr:7878 in Docker);
  # set this field only if you need a custom host.
  # url:
  apiKey: your-radarr-api-key

openai:
  apiKey: your-openai-api-key
  # Default: gpt-4.1 (supports json_schema structured outputs for stricter validation).
  # Rationale: maximize schema compliance and reduce malformed responses.
  model: gpt-4.1
  # Default: 0.15
  # Rationale: keep decisions consistent and grounded; higher values increase variance.
  temperature: 0.15
  # Default: 320
  # Rationale: enough for concise reasoning without encouraging verbosity.
  maxTokens: 320


thresholds:
  # Critic score thresholds (0-100). These define scoring bands and ambiguity checks.
  # criticHigh: top-tier critic band (adds criticHighBoost weight).
  criticHigh: 76
  # criticMid: strong critic band lower bound (adds criticMidBand weight).
  criticMid: 70
  # criticLow: lower critic band (may still influence score).
  criticLow: 65
  # criticBlock: very low critic band (used for signal classification).
  criticBlock: 60
  # Popularity index thresholds (computedPopularityIndex preferred, 0-100).
  # Uses Metacritic-style RAG bands: red < 40, yellow 40â€“60, green > 60.
  popularityHigh: 60
  popularityLow: 40

policyForAmbiguousCases:
  # LLM is used only when rules mark a case as ambiguous.
  useLLM: true
  # When useLLM is false, ambiguous items use this fallback profile.
  # Defaults to AutoAssignQuality (keeps profile unchanged).
  noLLMFallbackProfile: AutoAssignQuality

# DANGEROUS: when true, allows downgrading quality profiles even if the file is already 2160p.
# When false, any HD decision for a current 2160p file will be blocked and tagged "exceed".
# Exceeding-quality matches will be tagged as "exceed".
downgradeQualityProfile: false

rulesEngine:
  weights:
    # Huge boost so critic-high always lands in HighQuality-4K tier.
    criticHighBoost: 10
    criticMidBand: 1
    popularityStrong: 3
    popularityMid: 1
    visualRich: 2
    visualScorePerPoint: 0.5
  scoreThresholds:
    efficient4k: 3
    high4k: 7
  visualWeights:
    Action: 3
    War: 3
    Animation: 2
    Sci-Fi: 2
    Fantasy: 2
    Adventure: 1
    Thriller: 1
  visualScoreConfig:
    maxScore: 6
    richMin: 3
    lowMax: 1
  ambiguity:
    criticMidDelta: 1
    requirePopularityTier: mid
  # Rules run in priority order (higher wins). Each rule chooses a profile.
  rules:
    - name: score_high
      priority: 800
      conditions:
        all:
          - fact: decisionScoreTier
            operator: equal
            value: high
      event:
        type: decision
        params:
          profile: HighQuality-4K
    - name: score_mid
      priority: 700
      conditions:
        all:
          - fact: decisionScoreTier
            operator: equal
            value: mid
      event:
        type: decision
        params:
          profile: Efficient-4K
    - name: score_low
      priority: 600
      conditions:
        all:
          - fact: decisionScoreTier
            operator: equal
            value: low
      event:
        type: decision
        params:
          profile: HD

policies:
  reasoning:
    maxSentences: 2
    forbidCurrentTrendsClaims: true

reasonTags:
  pop: strong popularity signal
  crit: strong critic signal
  vis: visually rich signal
  lowq: current file is 720p or below
  weak: limited or low signal
  mix: mixed signals
  exceed: current file exceeds HD (2160p)

promptTemplate:
  prelude: |
    You are a Radarr quality profile decision agent. Respond ONLY with a single JSON object matching the schema. No markdown or code blocks.
  header: |
    Return keys: profile (one of {{allowedProfiles}}), rules (array using allowedReasons {{allowedReasons}}), reasoning (<= {{maxSentences}} sentences). Do not include other keys.
  constraints: |
    You are invoked only for ambiguous edge cases. Ground reasoning in provided fields/values (criticScore + criticScoreSource, popularity.primarySource/primaryScore/primaryVotes/computedPopularityIndex/rawPopularity, metacriticScore, rtAudienceScore, rtCriticScore, genres, currentQuality, lowq, signalSummary). If signals are missing or weak, choose the safer lower profile and say "limited signal". Use reasonDescriptions to pick rule(s). Avoid claims about current trends or unseen formats.
  inputs: |
    Input JSON includes title, year, genres, criticScore, criticScoreSource, popularity {primarySource, primaryScore, primaryVotes, tmdbScore, tmdbVotes, imdbScore, imdbVotes, computedPopularityIndex, rawPopularity}, metacriticScore, rtAudienceScore, rtAudienceVotes, rtCriticScore, rtCriticVotes, currentQuality, lowq, thresholds, rulesEngine {weights, scoreThresholds, visualWeights, visualScoreConfig}, signalSummary, policies, hints. Base decisions only on these fields; if data is missing or weak, choose the safer lower profile.
  groupsAndGenres: |
    Visual genres with high payoff (from visualWeights): {{visualGenres}}.

promptHints: |
  - You are invoked only for ambiguous edge cases. Use only the provided fields and thresholds.
  - Treat raw popularity as noisy; prefer computedPopularityIndex when available.
  - Do not infer anything beyond criticScore, popularity, genre, and visual richness signals.
  - Visual richness is a weighted score from visualWeights matches:
      Action=3, War=3, Animation=2, Sci-Fi=2, Fantasy=2, Adventure=1, Thriller=1.
  - Deterministic choices are score-based:
      * decisionScore is computed from rulesEngine.weights.
      * decisionScoreTier uses rulesEngine.scoreThresholds.
  - Profile intent summary:
      - HighQuality-4K: score tier high (critic-high adds a large boost).
      - Efficient-4K: score tier mid.
      - HD: score tier low.

# Save this to data/quality-broker/config/config.yaml
batchSize: 10
autoAssignProfile: AutoAssignQuality
# Optional: set to a profile name to re-evaluate all movies in that profile.
# Leave empty to only process AutoAssignQuality queue.
reviseQualityForProfile: ""
decisionProfiles:
  - HD
  - Efficient-4K
  - HighQuality-4K

radarr:
  # URL auto-derives from LAN_HOSTNAME/RADARR_PORT (or radarr:7878 in Docker);
  # set this field only if you need a custom host.
  # url:
  apiKey: your-radarr-api-key

openai:
  apiKey: your-openai-api-key
  # Default: gpt-4.1 (supports json_schema structured outputs for stricter validation).
  # Rationale: maximize schema compliance and reduce malformed responses.
  model: gpt-4.1
  # Default: 0.15
  # Rationale: keep decisions consistent and grounded; higher values increase variance.
  temperature: 0.15
  # Default: 320
  # Rationale: enough for concise reasoning without encouraging verbosity.
  maxTokens: 320


thresholds:
  # Critic score thresholds (0-100). These align with the deterministic rule table.
  # criticHigh: top-tier critical reception (auto HighQuality-4K)
  criticHigh: 76
  # criticMid: strong critic reception (70-75)
  criticMid: 70
  # criticLow: minimum critic signal to consider Efficient-4K
  criticLow: 65
  # criticBlock: hard block for HighQuality-4K at/below this score
  criticBlock: 60
  # Popularity index thresholds (computedPopularityIndex preferred, 0-100).
  # Uses Metacritic-style RAG bands: red < 40, yellow 40–60, green > 60.
  popularityHigh: 60
  popularityLow: 40
  allowPopularityTierFallback: true
  popularityTierFallbackMaxPopularity: 2

llmPolicy:
  enabled: true
  useOnAmbiguousOnly: true

# DANGEROUS: when true, allows downgrading quality profiles even if the file is already 2160p.
# When false, any HD decision for a current 2160p file will be blocked and tagged "exceed".
# Exceeding-quality matches will be tagged as "exceed".
downgradeQualityProfile: false

visualGenresHigh:
  - Action
  - Animation
  - Adventure
  - Sci-Fi
  - Fantasy
  - War
  - Thriller

policies:
  reasoning:
    maxSentences: 2
    forbidCurrentTrendsClaims: true
    allowTimelessCulturalInference: true

promptHints: |
  - You are invoked only for ambiguous edge cases. Use only the provided fields and thresholds.
  - Treat raw popularity as noisy; prefer computedPopularityIndex when available.
  - Do not infer anything beyond criticScore, popularity, genre, and visual richness signals.
  - Visual richness is a weighted score from visualGenresHigh matches:
      Action=3, War=3, Animation=2, Sci-Fi=2, Fantasy=2, Adventure=1, Thriller=1.

  - Deterministic rule table (use when ambiguous):
      * criticScore >= criticHigh → HighQuality-4K.
      * criticScore between criticMid and criticHigh:
          - HighQuality-4K only if strong popularity AND visual richness.
          - Otherwise Efficient-4K.
      * criticScore between criticLow and criticMid:
          - Efficient-4K only if strong popularity.
          - Otherwise HD.
      * criticScore <= criticBlock:
          - Never HighQuality-4K.
          - Efficient-4K only if visually rich with intense Action/War.
          - Otherwise HD.
      * Missing criticScore:
          - Efficient-4K only if strong popularity AND visual richness.
          - Otherwise HD.

  - Profile intent summary:
      - HighQuality-4K: top-tier critical reception or strong popularity + visual payoff.
      - Efficient-4K: solid signals or strong popularity with visual payoff.
      - HD: low-signal, low-score, or utility titles where 4K adds little value.

reasonTags:
  pop: strong popularity signal
  crit: strong critic signal
  vis: visually rich signal
  lowq: current file is 720p or below
  weak: limited or low signal
  mix: mixed signals
  exceed: current file exceeds HD (2160p)

promptTemplate:
  prelude: |
    You are a Radarr quality profile decision agent. Respond ONLY with a single JSON object matching the schema. No markdown or code blocks.
  header: |
    Return keys: profile (one of {{allowedProfiles}}), rules (array using allowedReasons {{allowedReasons}}), reasoning (<= {{maxSentences}} sentences). Include popularityTier (low|mid|high) ONLY when popularityTierPolicy.allow is true. Do not include other keys.
  constraints: |
    You are invoked only for ambiguous edge cases. Ground reasoning in provided fields/values (criticScore + criticScoreSource, popularity.primarySource/primaryScore/primaryVotes/computedPopularityIndex/rawPopularity, metacriticScore, rtAudienceScore, rtCriticScore, genres, currentQuality, mediaInfo, lowq, signalSummary). If signals are missing or weak, choose the safer lower profile and say "limited signal". Use reasonDescriptions to pick rule(s). Avoid claims about current trends or unseen formats.
  inputs: |
    Input JSON includes title, year, genres, runtime, criticScore, criticScoreSource, popularity {primarySource, primaryScore, primaryVotes, tmdbScore, tmdbVotes, imdbScore, imdbVotes, computedPopularityIndex, rawPopularity}, popularityTier, metacriticScore, rtAudienceScore, rtAudienceVotes, rtCriticScore, rtCriticVotes, currentQuality, mediaInfo, lowq, thresholds, visualGenresHigh, signalSummary, policies, hints, popularityTierPolicy.allow. Base decisions only on these fields; if data is missing or weak, choose the safer lower profile.
  popularityTierPolicy: |
    If popularityTierPolicy.allow is true, set popularityTier to low|mid|high using timeless popularity inference only. If false, omit popularityTier entirely.
  groupsAndGenres: |
    Visual genres with high payoff: {{visualGenresHigh}}.
